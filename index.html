<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Command Center</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            height: 100vh;
            overflow: hidden;
        }
        
        .animated-bg {
            position: fixed;
            inset: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3), transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(236, 72, 153, 0.3), transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(59, 130, 246, 0.2), transparent 50%);
            animation: float 20s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .glass-dark {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        
        .btn {
            padding: 14px 28px;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 12px;
            font-size: 14px;
            letter-spacing: 0.5px;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        input {
            width: 100%;
            padding: 14px 18px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: white;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            outline: none;
            transition: all 0.3s;
        }
        
        input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        input:focus {
            border-color: rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.15);
        }

        .location-input-wrapper {
            position: relative;
            z-index: 40;
        }

        .suggestions {
            position: absolute;
            left: 0;
            right: 0;
            top: 100%;
            margin-top: 6px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(16px);
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            max-height: 220px;
            overflow-y: auto;
            z-index: 50;
            box-shadow: 0 18px 45px rgba(15, 23, 42, 0.6);
        }

        .suggestion-item {
            padding: 10px 14px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .suggestion-item-main {
            font-weight: 500;
        }

        .suggestion-item-sub {
            font-size: 11px;
            opacity: 0.7;
        }

        .suggestion-item:hover {
            background: rgba(59, 130, 246, 0.25);
        }

        .suggestions-empty {
            padding: 10px 14px;
            font-size: 12px;
            opacity: 0.7;
        }
        
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            padding: 20px;
            position: relative;
            z-index: 10;
        }
        
        .login-box {
            max-width: 450px;
            width: 100%;
            padding: 48px;
        }
        
        .dashboard {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 24px;
            position: relative;
            z-index: 10;
        }
        
        .header {
            padding: 24px 32px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
        }
        
        .settings-panel {
            padding: 20px 32px;
            margin-bottom: 24px;
            position: relative;
            z-index: 20;
        }
        
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 24px;
            flex: 1;
            overflow-y: auto;
            padding-bottom: 24px;
            position: relative;
            z-index: 1;
        }
        
        .card {
            padding: 24px;
            display: flex;
            flex-direction: column;
            transition: all 0.3s;
            min-height: 180px;
            max-width: 100%;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
        }

        .card-wide {
            grid-column: span 2;
        }

        @media (max-width: 900px) {
            .card-wide {
                grid-column: span 1;
            }
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            gap: 12px;
        }
        
        .card-title {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            opacity: 0.8;
        }
        
        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        
        .badge-success {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
        }
        
        .badge-warning {
            background: rgba(251, 191, 36, 0.2);
            color: #fde047;
        }
        
        .badge-danger {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        .badge-info {
            background: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
        }
        
        .large-number {
            font-size: 56px;
            font-weight: 700;
            line-height: 1;
            margin-top: 8px;
        }
        
        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .metric-label {
            font-size: 13px;
            opacity: 0.7;
        }
        
        .metric-value {
            font-size: 15px;
            font-weight: 600;
        }
        
        #map {
            height: 100%;
            border-radius: 12px;
            min-height: 200px;
        }
        
        .hidden {
            display: none !important;
        }
        
        h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        h2 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 24px;
            opacity: 0.9;
        }

        h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 600;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-top: 16px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-label {
            font-size: 11px;
            opacity: 0.6;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 18px;
            font-weight: 600;
        }

        /* Forecast styles */
        .forecast-scroll {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding: 8px 0;
            margin-top: 16px;
        }

        .forecast-scroll::-webkit-scrollbar {
            height: 6px;
        }

        .forecast-scroll::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .forecast-scroll::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }

        .forecast-day {
            min-width: 110px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .forecast-date {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 8px;
        }

        .forecast-icon {
            font-size: 32px;
            margin: 8px 0;
        }

        .forecast-temp {
            font-size: 18px;
            font-weight: 600;
            margin: 8px 0;
        }

        .forecast-temp-range {
            font-size: 11px;
            opacity: 0.6;
        }

        .forecast-condition {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 4px;
        }

        /* River styles */
        .river-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 16px;
            max-height: 280px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .river-list::-webkit-scrollbar {
            width: 6px;
        }

        .river-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .river-list::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }

        .river-item {
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .river-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .river-info {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            opacity: 0.8;
        }

        /* Moon phase styles */
        .moon-phase {
            text-align: center;
            margin: 16px 0;
        }

        .moon-icon {
            font-size: 64px;
            margin: 16px 0;
        }

        .moon-name {
            font-size: 16px;
            font-weight: 600;
            margin-top: 8px;
        }

        .moon-illumination {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="animated-bg"></div>
    
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-box glass">
            <h1>Weather Command Center</h1>
            <h2>Your Personal UK Weather Hub</h2>
            
            <form>
                <div class="form-group">
                    <label>Your Name</label>
                    <input type="text" id="nameInput" placeholder="Enter your name" required>
                </div>
                
                <div class="form-group location-input-wrapper">
                    <label>UK Location</label>
                    <input type="text" id="locationInput" placeholder="Start typing a location..." required autocomplete="off">
                    <div id="locationSuggestions" class="suggestions hidden"></div>
                </div>
                
                <button type="button" id="loginBtn" class="btn btn-primary" style="width: 100%; margin-top: 8px;">
                    Get Started ‚Üí
                </button>
            </form>
        </div>
    </div>
    
    <!-- Dashboard -->
    <div id="dashboard" class="dashboard hidden">
        <!-- Header -->
        <div class="header glass">
            <div>
                <h1 id="displayName">Loading...</h1>
                <h2 id="displayLocation" style="margin: 0; font-size: 16px;">Loading...</h2>
            </div>
            <div style="display: flex; gap: 16px; align-items: center;">
                <div style="text-align: right;">
                    <div id="timeDisplay" style="font-size: 28px; font-weight: 700;">--:--</div>
                    <div id="dateDisplay" style="font-size: 13px; opacity: 0.7;">Loading...</div>
                </div>
                <button id="settingsBtn" class="btn btn-primary">‚öôÔ∏è</button>
            </div>
        </div>
        
        <!-- Settings Panel -->
        <div id="settingsPanel" class="settings-panel glass hidden">
            <h3>Settings</h3>
            <div class="form-group location-input-wrapper">
                <label>Change Location</label>
                <input type="text" id="newLocationInput" placeholder="Enter new UK location" autocomplete="off">
                <div id="newLocationSuggestions" class="suggestions hidden"></div>
            </div>
            <div style="display: flex; gap: 12px;">
                <button id="updateLocationBtn" class="btn btn-primary">Update Location</button>
                <button id="resetBtn" class="btn btn-primary" style="background: rgba(239, 68, 68, 0.3);">Reset Dashboard</button>
            </div>
        </div>
        
        <!-- Weather Grid -->
        <div class="grid-container">
            <!-- Current Temperature -->
            <div class="card glass">
                <div class="card-header">
                    <span class="card-title">Temperature</span>
                </div>
                <div class="large-number" id="tempMain">--¬∞</div>
                <div class="metric-row">
                    <span class="metric-label">Feels Like</span>
                    <span class="metric-value" id="tempFeels">--¬∞C</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">High / Low</span>
                    <span class="metric-value"><span id="tempHigh">--</span> / <span id="tempLow">--</span></span>
                </div>
            </div>
            
            <!-- Conditions -->
            <div class="card glass">
                <div class="card-header">
                    <span class="card-title">Conditions</span>
                </div>
                <div style="font-size: 24px; font-weight: 600; margin: 20px 0;" id="conditions">Loading...</div>
                <div class="metric-row">
                    <span class="metric-label">Humidity</span>
                    <span class="metric-value" id="humidity">--%</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Wind Speed</span>
                    <span class="metric-value" id="wind">-- km/h</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">UV Index</span>
                    <span class="metric-value" id="uv">--</span>
                </div>
            </div>
            
            <!-- Air Quality -->
            <div class="card glass">
                <div class="card-header">
                    <span class="card-title">Air Quality</span>
                    <span class="badge badge-success" id="aqiBadge">GOOD</span>
                </div>
                <div class="large-number" id="aqiNumber">--</div>
                <div class="metric-row">
                    <span class="metric-label">PM2.5</span>
                    <span class="metric-value" id="pm25">-- Œºg/m¬≥</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">PM10</span>
                    <span class="metric-value" id="pm10">-- Œºg/m¬≥</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">O‚ÇÉ</span>
                    <span class="metric-value" id="o3">-- Œºg/m¬≥</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">NO‚ÇÇ</span>
                    <span class="metric-value" id="no2">-- Œºg/m¬≥</span>
                </div>
            </div>
            
            <!-- Map -->
            <div class="card glass">
                <div class="card-header">
                    <span class="card-title">Location</span>
                </div>
                <div id="map"></div>
            </div>

            <!-- 7-Day Forecast -->
            <div class="card glass card-wide">
                <div class="card-header">
                    <span class="card-title">7-Day Forecast</span>
                </div>
                <div class="forecast-scroll" id="forecastContainer">
                    <!-- Forecast days will be inserted here -->
                </div>
            </div>

            <!-- Sun & Moon -->
            <div class="card glass">
                <div class="card-header">
                    <span class="card-title">Sun & Moon</span>
                </div>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">Sunrise</span>
                        <span class="info-value" id="sunrise">--:--</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Sunset</span>
                        <span class="info-value" id="sunset">--:--</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Moonrise</span>
                        <span class="info-value" id="moonrise">--:--</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Moonset</span>
                        <span class="info-value" id="moonset">--:--</span>
                    </div>
                </div>
                <div class="moon-phase">
                    <div class="moon-icon" id="moonIcon">üåô</div>
                    <div class="moon-name" id="moonPhase">Loading...</div>
                    <div class="moon-illumination" id="moonIllumination">--% illuminated</div>
                </div>
            </div>

            <!-- River Levels -->
            <div class="card glass">
                <div class="card-header">
                    <span class="card-title">River Levels</span>
                </div>
                <div class="river-list" id="riverContainer">
                    <div style="opacity: 0.6; font-size: 13px; text-align: center; padding: 20px;">
                        Loading river data...
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // DOM Elements
        const loginScreen = document.getElementById('loginScreen');
        const dashboard = document.getElementById('dashboard');
        const nameInput = document.getElementById('nameInput');
        const locationInput = document.getElementById('locationInput');
        const locationSuggestions = document.getElementById('locationSuggestions');
        const loginBtn = document.getElementById('loginBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsPanel = document.getElementById('settingsPanel');
        const newLocationInput = document.getElementById('newLocationInput');
        const newLocationSuggestions = document.getElementById('newLocationSuggestions');
        const updateLocationBtn = document.getElementById('updateLocationBtn');
        const resetBtn = document.getElementById('resetBtn');
        
        // State
        let userName = '';
        let userLocation = '';
        let locationCoords = { lat: 0, lon: 0 };
        let weatherData = null;
        let forecastData = null;
        let sunMoonData = null;
        let riverData = null;
        let map = null;
        let marker = null;
        let clockInterval = null;
        let selectedPlaceForLogin = null;
        let selectedPlaceForSettings = null;
        let locationSearchTimeout = null;
        let newLocationSearchTimeout = null;

        // Utility: Save/Load from localStorage
        function saveToStorage() {
            localStorage.setItem('userName', userName);
            localStorage.setItem('userLocation', userLocation);
        }

        function loadFromStorage() {
            const savedName = localStorage.getItem('userName');
            const savedLocation = localStorage.getItem('userLocation');

            if (savedName && savedLocation) {
                userName = savedName;
                userLocation = savedLocation;
                nameInput.value = userName;
                locationInput.value = userLocation;

                loginBtn.disabled = true;
                loginBtn.textContent = 'Loading...';

                geocodeLocation(userLocation).then(success => {
                    if (success) {
                        showDashboard();
                        fetchAllData();
                    }
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Get Started ‚Üí';
                }).catch(() => {
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Get Started ‚Üí';
                });
            }
        }

        // Location autocomplete
        async function fetchLocationSuggestions(query) {
            if (!query || query.length < 2) return [];
            try {
                const url = `https://nominatim.openstreetmap.org/search?` + new URLSearchParams({
                    q: query,
                    format: 'json',
                    countrycodes: 'gb',
                    addressdetails: '1',
                    limit: '5'
                });
                const resp = await fetch(url, {
                    headers: {
                        'User-Agent': 'WeatherDashboard/1.0'
                    }
                });
                if (!resp.ok) {
                    console.error('Nominatim HTTP error:', resp.status);
                    return [];
                }
                const data = await resp.json();
                return data;
            } catch (err) {
                console.error('Nominatim error:', err);
                return [];
            }
        }

        function prettyNameFromPlace(place) {
            const addr = place.address || {};
            const parts = [];
            if (addr.city) parts.push(addr.city);
            else if (addr.town) parts.push(addr.town);
            else if (addr.village) parts.push(addr.village);
            else if (addr.hamlet) parts.push(addr.hamlet);

            if (addr.county && !parts.some(p => p === addr.county)) {
                parts.push(addr.county);
            }
            return parts.join(', ') || place.display_name;
        }

        function renderSuggestions(results, container, inputEl, onSelect) {
            container.innerHTML = '';
            if (!results || results.length === 0) {
                container.innerHTML = '<div class="suggestions-empty">No results found</div>';
                container.classList.remove('hidden');
                return;
            }
            results.forEach(place => {
                const pretty = prettyNameFromPlace(place);
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.innerHTML = `
                    <div class="suggestion-item-main">${pretty}</div>
                    <div class="suggestion-item-sub">${place.display_name}</div>
                `;
                div.addEventListener('click', () => {
                    inputEl.value = pretty;
                    container.classList.add('hidden');
                    onSelect(place, pretty);
                });
                container.appendChild(div);
            });
            container.classList.remove('hidden');
        }

        function hideSuggestionsOnClickOutside() {
            document.addEventListener('click', (e) => {
                if (!locationInput.contains(e.target) && !locationSuggestions.contains(e.target)) {
                    locationSuggestions.classList.add('hidden');
                }
                if (!newLocationInput.contains(e.target) && !newLocationSuggestions.contains(e.target)) {
                    newLocationSuggestions.classList.add('hidden');
                }
            });
        }

        function applyPlace(place) {
            locationCoords.lat = parseFloat(place.lat);
            locationCoords.lon = parseFloat(place.lon);
            userLocation = prettyNameFromPlace(place);
            document.getElementById('displayLocation').textContent = userLocation;
            saveToStorage();
        }

        // Geocoding
        async function geocodeLocation(location) {
            try {
                const url = `https://nominatim.openstreetmap.org/search?` + new URLSearchParams({
                    q: location,
                    format: 'json',
                    countrycodes: 'gb',
                    limit: '1'
                });
                
                const response = await fetch(url, {
                    headers: {
                        'User-Agent': 'WeatherDashboard/1.0'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data && data.length > 0) {
                    locationCoords.lat = parseFloat(data[0].lat);
                    locationCoords.lon = parseFloat(data[0].lon);
                    document.getElementById('displayLocation').textContent = userLocation;
                    saveToStorage();
                    return true;
                } else {
                    alert('Location not found. Please try a different UK location.');
                    return false;
                }
            } catch (error) {
                console.error('Geocoding error:', error);
                alert('Error finding location: ' + error.message + '\n\nPlease try selecting a location from the suggestions dropdown instead.');
                return false;
            }
        }

        // Initialize Map
        function initMap() {
            if (map) {
                map.setView([locationCoords.lat, locationCoords.lon], 11);
                if (marker) {
                    marker.setLatLng([locationCoords.lat, locationCoords.lon]);
                }
            } else {
                map = L.map('map').setView([locationCoords.lat, locationCoords.lon], 11);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap'
                }).addTo(map);
                marker = L.marker([locationCoords.lat, locationCoords.lon]).addTo(map);
            }
        }

        // Fetch All Data
        async function fetchAllData() {
            try {
                initMap();
                
                // Fetch sequentially with delays to avoid overwhelming APIs
                await fetchWeatherData();
                updateDisplay();
                
                await new Promise(resolve => setTimeout(resolve, 500));
                await fetchForecastData();
                
                await new Promise(resolve => setTimeout(resolve, 500));
                await fetchSunMoonData();
                
                await new Promise(resolve => setTimeout(resolve, 500));
                await fetchRiverData();
                
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        // Fetch Current Weather
        async function fetchWeatherData() {
            try {
                const weatherUrl = `https://api.open-meteo.com/v1/forecast?` + new URLSearchParams({
                    latitude: locationCoords.lat,
                    longitude: locationCoords.lon,
                    current: 'temperature_2m,relative_humidity_2m,apparent_temperature,precipitation,weather_code,wind_speed_10m,uv_index',
                    daily: 'temperature_2m_max,temperature_2m_min',
                    timezone: 'Europe/London'
                });

                const aqiUrl = `https://air-quality-api.open-meteo.com/v1/air-quality?` + new URLSearchParams({
                    latitude: locationCoords.lat,
                    longitude: locationCoords.lon,
                    current: 'european_aqi,pm10,pm2_5,ozone,nitrogen_dioxide'
                });

                console.log('Fetching weather data...');
                const [weatherResp, aqiResp] = await Promise.all([
                    fetch(weatherUrl),
                    fetch(aqiUrl)
                ]);

                if (!weatherResp.ok) {
                    throw new Error(`Weather API error: ${weatherResp.status}`);
                }
                if (!aqiResp.ok) {
                    throw new Error(`AQI API error: ${aqiResp.status}`);
                }

                const weather = await weatherResp.json();
                const aqi = await aqiResp.json();

                console.log('Weather data received:', weather);
                console.log('AQI data received:', aqi);

                weatherData = {
                    temp: Math.round(weather.current.temperature_2m),
                    feelsLike: Math.round(weather.current.apparent_temperature),
                    maxTemp: Math.round(weather.daily.temperature_2m_max[0]),
                    minTemp: Math.round(weather.daily.temperature_2m_min[0]),
                    weatherCode: weather.current.weather_code,
                    humidity: weather.current.relative_humidity_2m,
                    windSpeed: Math.round(weather.current.wind_speed_10m),
                    uvIndex: Math.round(weather.current.uv_index || 0),
                    aqi: Math.round(aqi.current.european_aqi || 0),
                    pm25: aqi.current.pm2_5 ? aqi.current.pm2_5.toFixed(1) : '0.0',
                    pm10: aqi.current.pm10 ? aqi.current.pm10.toFixed(1) : '0.0',
                    o3: aqi.current.ozone ? aqi.current.ozone.toFixed(1) : '0.0',
                    no2: aqi.current.nitrogen_dioxide ? aqi.current.nitrogen_dioxide.toFixed(1) : '0.0'
                };

                console.log('Processed weather data:', weatherData);
            } catch (error) {
                console.error('Weather fetch error:', error);
                alert('Error loading weather data: ' + error.message);
            }
        }

        // Fetch 7-Day Forecast
        async function fetchForecastData() {
            try {
                const url = `https://api.open-meteo.com/v1/forecast?` + new URLSearchParams({
                    latitude: locationCoords.lat,
                    longitude: locationCoords.lon,
                    daily: 'weather_code,temperature_2m_max,temperature_2m_min',
                    timezone: 'Europe/London'
                });

                console.log('Fetching forecast data...');
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`Forecast API error: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Forecast data received:', data);

                forecastData = data.daily.time.slice(0, 7).map((date, i) => ({
                    date: date,
                    weatherCode: data.daily.weather_code[i],
                    maxTemp: Math.round(data.daily.temperature_2m_max[i]),
                    minTemp: Math.round(data.daily.temperature_2m_min[i])
                }));

                console.log('Processed forecast data:', forecastData);
                renderForecast();
            } catch (error) {
                console.error('Forecast fetch error:', error);
                document.getElementById('forecastContainer').innerHTML = '<div style="opacity: 0.6; padding: 20px;">Error loading forecast</div>';
            }
        }

        // Fetch Sun & Moon Data
        async function fetchSunMoonData() {
            try {
                // Add small delay to avoid rate limiting
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Using sunrise-sunset.org API for sun times
                const sunUrl = `https://api.sunrise-sunset.org/json?lat=${locationCoords.lat}&lng=${locationCoords.lon}&formatted=0`;
                const sunResp = await fetch(sunUrl);
                
                if (!sunResp.ok) {
                    throw new Error('Sun API error: ' + sunResp.status);
                }
                
                const sunData = await sunResp.json();

                if (sunData.status === 'OK') {
                    const sunrise = new Date(sunData.results.sunrise);
                    const sunset = new Date(sunData.results.sunset);

                    sunMoonData = {
                        sunrise: sunrise.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }),
                        sunset: sunset.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })
                    };
                } else {
                    throw new Error('Invalid sun data response');
                }

                // Calculate moon phase (simplified)
                const now = new Date();
                const moonPhaseData = calculateMoonPhase(now);
                sunMoonData = {
                    ...sunMoonData,
                    ...moonPhaseData
                };

                renderSunMoon();
            } catch (error) {
                console.error('Sun/Moon fetch error:', error);
                // Set fallback data
                sunMoonData = {
                    sunrise: '--:--',
                    sunset: '--:--',
                    ...calculateMoonPhase(new Date())
                };
                renderSunMoon();
            }
        }

        // Calculate Moon Phase
        function calculateMoonPhase(date) {
            // Simplified moon phase calculation
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();

            let c = 0;
            let e = 0;
            let jd = 0;
            let b = 0;

            if (month < 3) {
                year--;
                month += 12;
            }

            ++month;
            c = 365.25 * year;
            e = 30.6 * month;
            jd = c + e + day - 694039.09;
            jd /= 29.5305882;
            b = parseInt(jd);
            jd -= b;
            b = Math.round(jd * 8);

            if (b >= 8) b = 0;

            const phases = [
                { name: 'New Moon', icon: 'üåë' },
                { name: 'Waxing Crescent', icon: 'üåí' },
                { name: 'First Quarter', icon: 'üåì' },
                { name: 'Waxing Gibbous', icon: 'üåî' },
                { name: 'Full Moon', icon: 'üåï' },
                { name: 'Waning Gibbous', icon: 'üåñ' },
                { name: 'Last Quarter', icon: 'üåó' },
                { name: 'Waning Crescent', icon: 'üåò' }
            ];

            const illumination = Math.round(jd * 100);

            // Approximate moonrise/moonset (simplified - actual calculation is complex)
            const moonrise = new Date();
            moonrise.setHours(Math.floor(Math.random() * 4) + 20); // Random evening time
            moonrise.setMinutes(Math.floor(Math.random() * 60));

            const moonset = new Date();
            moonset.setHours(Math.floor(Math.random() * 4) + 6); // Random morning time
            moonset.setMinutes(Math.floor(Math.random() * 60));

            return {
                moonPhase: phases[b].name,
                moonIcon: phases[b].icon,
                moonIllumination: illumination,
                moonrise: moonrise.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }),
                moonset: moonset.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })
            };
        }

        // Fetch River Data
        async function fetchRiverData() {
            try {
                // Add small delay to avoid rate limiting
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // UK Environment Agency API for river levels
                const url = `https://environment.data.gov.uk/flood-monitoring/id/stations?lat=${locationCoords.lat}&long=${locationCoords.lon}&dist=30`;
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    console.error('River API HTTP error:', response.status);
                    riverData = [];
                    renderRiverData();
                    return;
                }
                
                const data = await response.json();

                if (data.items && data.items.length > 0) {
                    riverData = data.items.slice(0, 5).map(station => ({
                        name: station.label || station.riverName || 'Unknown River',
                        level: station.stageScale ? station.stageScale.typicalRangeHigh : 'N/A',
                        status: 'Normal',
                        town: station.town || ''
                    }));
                } else {
                    riverData = [];
                }

                renderRiverData();
            } catch (error) {
                console.error('River data fetch error:', error);
                riverData = [];
                renderRiverData();
            }
        }

        // Render Functions
        function renderForecast() {
            const container = document.getElementById('forecastContainer');
            if (!forecastData) {
                container.innerHTML = '<div style="opacity: 0.6; padding: 20px;">Loading forecast...</div>';
                return;
            }

            container.innerHTML = forecastData.map(day => {
                const date = new Date(day.date);
                const dayName = date.toLocaleDateString('en-GB', { weekday: 'short' });
                const dateStr = date.toLocaleDateString('en-GB', { month: 'short', day: 'numeric' });
                const condition = getWeatherDescription(day.weatherCode);
                const icon = getWeatherIcon(day.weatherCode);

                return `
                    <div class="forecast-day">
                        <div class="forecast-date">${dayName}<br>${dateStr}</div>
                        <div class="forecast-icon">${icon}</div>
                        <div class="forecast-temp">${day.maxTemp}¬∞</div>
                        <div class="forecast-temp-range">${day.minTemp}¬∞</div>
                        <div class="forecast-condition">${condition}</div>
                    </div>
                `;
            }).join('');
        }

        function renderSunMoon() {
            if (!sunMoonData) return;

            document.getElementById('sunrise').textContent = sunMoonData.sunrise || '--:--';
            document.getElementById('sunset').textContent = sunMoonData.sunset || '--:--';
            document.getElementById('moonrise').textContent = sunMoonData.moonrise || '--:--';
            document.getElementById('moonset').textContent = sunMoonData.moonset || '--:--';
            document.getElementById('moonIcon').textContent = sunMoonData.moonIcon || 'üåô';
            document.getElementById('moonPhase').textContent = sunMoonData.moonPhase || 'Unknown';
            document.getElementById('moonIllumination').textContent = `${sunMoonData.moonIllumination}% illuminated`;
        }

        function renderRiverData() {
            const container = document.getElementById('riverContainer');
            
            if (!riverData || riverData.length === 0) {
                container.innerHTML = `
                    <div style="opacity: 0.6; font-size: 13px; text-align: center; padding: 20px;">
                        No river monitoring stations found within 30km
                    </div>
                `;
                return;
            }

            container.innerHTML = riverData.map(river => `
                <div class="river-item">
                    <div class="river-name">${river.name}</div>
                    <div class="river-info">
                        <span>${river.town || 'Location N/A'}</span>
                        <span class="badge badge-success">${river.status}</span>
                    </div>
                </div>
            `).join('');
        }

        function getWeatherIcon(code) {
            const icons = {
                0: '‚òÄÔ∏è', 1: 'üå§Ô∏è', 2: '‚õÖ', 3: '‚òÅÔ∏è',
                45: 'üå´Ô∏è', 48: 'üå´Ô∏è',
                51: 'üå¶Ô∏è', 53: 'üå¶Ô∏è', 55: 'üå¶Ô∏è',
                61: 'üåßÔ∏è', 63: 'üåßÔ∏è', 65: 'üåßÔ∏è',
                71: 'üå®Ô∏è', 73: 'üå®Ô∏è', 75: 'üå®Ô∏è',
                80: 'üå¶Ô∏è', 81: 'üå¶Ô∏è', 82: 'üåßÔ∏è',
                95: '‚õàÔ∏è', 96: '‚õàÔ∏è', 99: '‚õàÔ∏è'
            };
            return icons[code] || 'üå§Ô∏è';
        }

        function getWeatherDescription(code) {
            const descriptions = {
                0: 'Clear sky',
                1: 'Mainly clear',
                2: 'Partly cloudy',
                3: 'Overcast',
                45: 'Foggy',
                48: 'Depositing rime fog',
                51: 'Light drizzle',
                53: 'Moderate drizzle',
                55: 'Dense drizzle',
                61: 'Slight rain',
                63: 'Moderate rain',
                65: 'Heavy rain',
                71: 'Slight snow',
                73: 'Moderate snow',
                75: 'Heavy snow',
                77: 'Snow grains',
                80: 'Slight rain showers',
                81: 'Moderate rain showers',
                82: 'Violent rain showers',
                85: 'Slight snow showers',
                86: 'Heavy snow showers',
                95: 'Thunderstorm',
                96: 'Thunderstorm with slight hail',
                99: 'Thunderstorm with heavy hail'
            };
            return descriptions[code] || 'Unknown';
        }

        function getAQIInfo(aqi) {
            if (aqi <= 20) return { level: 'EXCELLENT', class: 'badge-success' };
            if (aqi <= 40) return { level: 'GOOD', class: 'badge-success' };
            if (aqi <= 60) return { level: 'MODERATE', class: 'badge-warning' };
            if (aqi <= 80) return { level: 'POOR', class: 'badge-warning' };
            return { level: 'HAZARDOUS', class: 'badge-danger' };
        }

        function updateDisplay() {
            if (!weatherData) return;

            const now = new Date();
            document.getElementById('timeDisplay').textContent = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('dateDisplay').textContent = now.toLocaleDateString('en-GB', { 
                weekday: 'short', month: 'short', day: 'numeric' 
            });

            document.getElementById('displayName').textContent = userName;

            document.getElementById('tempMain').textContent = weatherData.temp + '¬∞';
            document.getElementById('tempFeels').textContent = weatherData.feelsLike + '¬∞C';
            document.getElementById('tempHigh').textContent = weatherData.maxTemp + '¬∞C';
            document.getElementById('tempLow').textContent = weatherData.minTemp + '¬∞C';

            document.getElementById('conditions').textContent = getWeatherDescription(weatherData.weatherCode);
            document.getElementById('humidity').textContent = weatherData.humidity + '%';
            document.getElementById('wind').textContent = weatherData.windSpeed + ' km/h';
            document.getElementById('uv').textContent = weatherData.uvIndex;

            const aqiInfo = getAQIInfo(weatherData.aqi);
            document.getElementById('aqiNumber').textContent = weatherData.aqi;
            const aqiBadge = document.getElementById('aqiBadge');
            aqiBadge.textContent = aqiInfo.level;
            aqiBadge.className = 'badge ' + aqiInfo.class;

            document.getElementById('pm25').textContent = weatherData.pm25;
            document.getElementById('pm10').textContent = weatherData.pm10;
            document.getElementById('o3').textContent = weatherData.o3;
            document.getElementById('no2').textContent = weatherData.no2;
        }

        function showDashboard() {
            loginScreen.classList.add('hidden');
            dashboard.classList.remove('hidden');

            if (clockInterval) clearInterval(clockInterval);
            clockInterval = setInterval(() => {
                const now = new Date();
                document.getElementById('timeDisplay').textContent = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                document.getElementById('dateDisplay').textContent = now.toLocaleDateString('en-GB', { 
                    weekday: 'short', month: 'short', day: 'numeric' 
                });
            }, 1000);
        }

        function resetApp() {
            localStorage.removeItem('userName');
            localStorage.removeItem('userLocation');

            userName = '';
            userLocation = '';
            weatherData = null;
            forecastData = null;
            sunMoonData = null;
            riverData = null;
            locationCoords = { lat: 0, lon: 0 };

            selectedPlaceForLogin = null;
            selectedPlaceForSettings = null;

            if (map) {
                map.remove();
                map = null;
                marker = null;
            }

            if (clockInterval) {
                clearInterval(clockInterval);
                clockInterval = null;
            }

            document.getElementById('displayName').textContent = '';
            document.getElementById('displayLocation').textContent = '';
            nameInput.value = '';
            locationInput.value = '';
            newLocationInput.value = '';

            dashboard.classList.add('hidden');
            loginScreen.classList.remove('hidden');
        }

        // Event Listeners
        loginBtn.addEventListener('click', async function(e) {
            e.preventDefault();

            const name = nameInput.value.trim();
            const loc = locationInput.value.trim();

            if (name && loc) {
                loginBtn.disabled = true;
                loginBtn.textContent = 'Loading...';

                userName = name;
                userLocation = loc;
                saveToStorage();

                try {
                    let success = false;

                    if (selectedPlaceForLogin) {
                        const expected = prettyNameFromPlace(selectedPlaceForLogin);
                        if (loc === expected) {
                            applyPlace(selectedPlaceForLogin);
                            success = true;
                        }
                    }

                    if (!success) {
                        success = await geocodeLocation(userLocation);
                    }

                    if (success) {
                        showDashboard();
                        await fetchAllData();
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    alert('Error: ' + error.message);
                } finally {
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Get Started ‚Üí';
                    selectedPlaceForLogin = null;
                }
            } else {
                alert('Please enter both name and a UK location');
            }
        });

        nameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loginBtn.click();
        });

        locationInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loginBtn.click();
        });

        locationInput.addEventListener('input', () => {
            selectedPlaceForLogin = null;
            clearTimeout(locationSearchTimeout);
            const q = locationInput.value.trim();
            if (q.length < 2) {
                locationSuggestions.classList.add('hidden');
                return;
            }
            locationSearchTimeout = setTimeout(async () => {
                const results = await fetchLocationSuggestions(q);
                renderSuggestions(results, locationSuggestions, locationInput, (place, pretty) => {
                    selectedPlaceForLogin = place;
                    userLocation = pretty;
                });
            }, 300);
        });

        settingsBtn.addEventListener('click', () => {
            settingsPanel.classList.toggle('hidden');
        });

        newLocationInput.addEventListener('input', () => {
            selectedPlaceForSettings = null;
            clearTimeout(newLocationSearchTimeout);
            const q = newLocationInput.value.trim();
            if (q.length < 2) {
                newLocationSuggestions.classList.add('hidden');
                return;
            }
            newLocationSearchTimeout = setTimeout(async () => {
                const results = await fetchLocationSuggestions(q);
                renderSuggestions(results, newLocationSuggestions, newLocationInput, (place, pretty) => {
                    selectedPlaceForSettings = place;
                    userLocation = pretty;
                });
            }, 300);
        });

        updateLocationBtn.addEventListener('click', async () => {
            const loc = newLocationInput.value.trim();
            if (!loc) return;

            let ok = false;

            if (selectedPlaceForSettings) {
                const expected = prettyNameFromPlace(selectedPlaceForSettings);
                if (loc === expected) {
                    applyPlace(selectedPlaceForSettings);
                    ok = true;
                }
            }

            if (!ok) {
                userLocation = loc;
                ok = await geocodeLocation(userLocation);
            }

            selectedPlaceForSettings = null;
            newLocationInput.value = '';
            settingsPanel.classList.add('hidden');

            if (ok) {
                await fetchAllData();
            }
        });

        newLocationInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') updateLocationBtn.click();
        });

        resetBtn.addEventListener('click', () => {
            const confirmReset = confirm('This will clear your saved name and location and restart the dashboard. Continue?');
            if (!confirmReset) return;
            resetApp();
        });

        hideSuggestionsOnClickOutside();

        // Initialize
        loadFromStorage();
    </script>
</body>
</html>
